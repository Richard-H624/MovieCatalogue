<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Series Grid â€” Movie Reviews</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .series-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 2rem; padding: 2rem; }
    .series-card { cursor: pointer; transition: transform 0.15s; min-height: 360px; }
    .series-card:hover { transform: translateY(-4px); }
    .series-card .card-body { display: flex; flex-direction: column; justify-content: space-between; padding: 1rem; }
    .series-card .card-img-top { width: 100%; height: 200px; object-fit: cover; border-radius: .4rem; margin-bottom: 1rem; }
    .flash-outline { box-shadow: 0 0 0 6px rgba(255,200,0,0.25) !important; }
    .modal-body { max-height: 70vh; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Movie Series Grid</h1>
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-primary" href="index.html">Home</a>
        <a class="btn btn-sm btn-outline-primary" href="MovieSeriesReviews.html">Reviews</a>
        <a class="btn btn-sm btn-outline-primary" href="MovieOneOffs.html">One-Off Movies</a>
      </div>
    </div>

    <div class="mb-3"><button class="btn btn-primary" onclick="location.href='MovieSeriesReviews.html'">Back to Reviews</button></div>

    <div id="series-grid" class="series-grid"></div>
  </div>

  <div class="modal fade" id="seriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 id="seriesModalLabel" class="modal-title"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4"><img id="modal-poster" src="" class="img-fluid" alt=""></div>
            <div class="col-md-8">
              <p id="modal-summary"></p>
              <p><strong>Year:</strong> <span id="modal-year"></span></p>
              <p><strong>Rating:</strong> <span id="modal-rating"></span></p>
              <p><strong>Budget:</strong> <span id="modal-budget"></span></p>
              <p><strong>Earnings:</strong> <span id="modal-earnings"></span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <div>
            <button id="prev-series" class="btn btn-secondary">Previous Series</button>
            <button id="next-series" class="btn btn-secondary">Next Series</button>
          </div>
          <div>
            <button id="prev-ep" class="btn btn-secondary">Previous Entry</button>
            <button id="next-ep" class="btn btn-secondary">Next Entry</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="ratings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const gid = id => document.getElementById(id);
    function normalizeForHash(raw){ return raw ? encodeURIComponent(String(raw).trim()).toLowerCase() : ''; }

    let allSeries = [];
    let currentSeriesIdx = 0;
    let currentEpisodeIdx = 0;
    let gridModal = null;

    function renderGrid(series){
      const grid = gid('series-grid');
      grid.innerHTML = '';
      series.forEach((s, idx)=>{
        const first = (s.episodes && s.episodes[0]) || {};
        const enc = normalizeForHash(first.title || s.name || '');
        const card = document.createElement('div');
        card.className = 'series-card card shadow-sm';
        card.setAttribute('data-title', enc);
        card.innerHTML = `
          <img src="${first.poster||''}" class="card-img-top" alt="${s.name||''}">
          <div class="card-body">
            <h6 class="card-title">${s.name||''}</h6>
            <p class="card-text">${(first.summary||'').slice(0,150)}${(first.summary && first.summary.length>150)?'...':''}</p>
          </div>
        `;
        card.addEventListener('click', ()=> showSeriesModal(idx,0));
        grid.appendChild(card);
      });
    }

    function showSeriesModal(seriesIdx, epIdx){
      currentSeriesIdx = seriesIdx; currentEpisodeIdx = epIdx;
      const s = allSeries[seriesIdx] || {}; const ep = (s.episodes && s.episodes[epIdx]) || {};
      gid('seriesModalLabel').textContent = ep.title || s.name || '';
      gid('modal-poster').src = ep.poster || '';
      gid('modal-summary').textContent = ep.summary || '';
      gid('modal-year').textContent = ep.year || '';
      gid('modal-rating').textContent = ep.rating || '';
      gid('modal-budget').textContent = ep.budget || '';
      gid('modal-earnings').textContent = ep.earnings || '';
      if(!gridModal) gridModal = new bootstrap.Modal(gid('seriesModal'));
      gridModal.show();
    }

    gid('prev-ep').addEventListener('click', ()=>{
      const s = allSeries[currentSeriesIdx]; if(!s||!s.episodes) return;
      currentEpisodeIdx = (currentEpisodeIdx - 1 + s.episodes.length) % s.episodes.length;
      showSeriesModal(currentSeriesIdx, currentEpisodeIdx);
    });
    gid('next-ep').addEventListener('click', ()=>{
      const s = allSeries[currentSeriesIdx]; if(!s||!s.episodes) return;
      currentEpisodeIdx = (currentEpisodeIdx + 1) % s.episodes.length;
      showSeriesModal(currentSeriesIdx, currentEpisodeIdx);
    });
    gid('prev-series').addEventListener('click', ()=>{
      if(!allSeries.length) return;
      currentSeriesIdx = (currentSeriesIdx - 1 + allSeries.length) % allSeries.length;
      showSeriesModal(currentSeriesIdx, 0);
    });
    gid('next-series').addEventListener('click', ()=>{
      if(!allSeries.length) return;
      currentSeriesIdx = (currentSeriesIdx + 1) % allSeries.length;
      showSeriesModal(currentSeriesIdx, 0);
    });

    function processHash(){
      if(!location.hash) return;
      const raw = location.hash.replace(/^#/,'');
      if(raw.indexOf('title=')===-1) return;
      try{
        const params = new URLSearchParams(raw);
        const t = params.get('title') || '';
        if(!t) return;
        const enc = String(t).toLowerCase();
        const card = document.querySelector(`[data-title="${enc}"]`) || document.querySelector(`[data-title="${decodeURIComponent(t).toLowerCase()}"]`);
        if(card){ card.scrollIntoView({behavior:'smooth', block:'center'}); card.classList.add('flash-outline'); setTimeout(()=>card.classList.remove('flash-outline'),2000); }
        // find index
        let idx = -1;
        for(let i=0;i<allSeries.length;i++){
          const first = (allSeries[i].episodes && allSeries[i].episodes[0]) || {};
          const cand = ((first.title||allSeries[i].name)||'').trim().toLowerCase();
          if(!cand) continue;
          if(cand === (decodeURIComponent(t)||'').trim().toLowerCase() || normalizeForHash(cand) === enc){ idx = i; break; }
        }
        if(idx >= 0) setTimeout(()=> showSeriesModal(idx,0), 250);
      }catch(e){ console.warn('processHash error', e); }
    }

    fetch('/api/movieseries', { cache:'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject('bad response'))
      .then(j => { allSeries = Array.isArray(j) ? j : []; renderGrid(allSeries); setTimeout(processHash, 120); })
      .catch(err => console.error('Failed to load series', err));

    window.addEventListener('hashchange', processHash);
  </script>
</body>
</html>