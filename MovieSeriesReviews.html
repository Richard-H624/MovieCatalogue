<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Series Watched 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .carousel-caption { background: rgba(0,0,0,0.5); border-radius:.5rem; padding:1rem; color:#fff; }
    .slide-img { width:100%; height:min(60vh,520px); object-fit:contain; display:block; cursor:pointer; }
    .debug-alert { position:fixed; right:1rem; bottom:1rem; z-index:1200; display:none; }
    .flash-outline { box-shadow: 0 0 0 6px rgba(255,200,0,0.25) !important; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-secondary" onclick="location.href='index.html'">⬅ Back</button>
      <h1 class="mb-0">Movie Series Watched 2025</h1>
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-primary" href="index.html">Home</a>
        <a class="btn btn-sm btn-outline-primary" href="MovieOneOffs.html">One-Offs</a>
        <a class="btn btn-sm btn-outline-primary" href="TelevisionSeriesReviews.html">TV Series</a>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body p-0">
        <div id="seriesCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner" id="series-carousel-inner"></div>
          <button class="carousel-control-prev" type="button" data-bs-target="#seriesCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#seriesCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>

    <h2 class="mb-3">Featured</h2>
    <div id="series-featured-row" class="row row-cols-1 row-cols-md-3 g-4 mb-4"></div>

    <div class="d-flex justify-content-end">
      <button id="grid-nav-btn" class="btn btn-primary">View Grid</button>
    </div>
  </div>

  <div class="modal fade" id="seriesQuickViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="row g-0">
          <div class="col-md-5"><img id="seriesQuickViewPoster" src="" class="img-fluid w-100 h-100" style="object-fit:cover;min-height:260px"></div>
          <div class="col-md-7 p-3">
            <h5 id="seriesQuickViewTitle"></h5>
            <p id="seriesQuickViewMeta" class="small text-muted"></p>
            <div id="seriesQuickViewSummary" style="max-height:18rem; overflow:auto"></div>
            <div class="d-flex justify-content-end gap-2 mt-3">
              <a id="seriesQuickViewOpenFull" class="btn btn-sm btn-primary" href="#">Open full page</a>
              <button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="seriesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 id="seriesModalTitle" class="modal-title"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <img id="seriesModalPoster" class="img-fluid mb-3" alt="poster" style="max-height:420px; object-fit:cover;">
          <p id="seriesModalSummary"></p>
          <p id="seriesModalBudget"></p>
          <p id="seriesModalEarnings"></p>
          <p id="seriesModalScore"></p>
        </div>
        <div class="modal-footer justify-content-between">
          <button id="prevSeriesEntry" class="btn btn-secondary">Previous Entry</button>
          <button id="nextSeriesEntry" class="btn btn-secondary">Next Entry</button>
        </div>
      </div>
    </div>
  </div>

  <div id="debugAlert" class="alert alert-warning debug-alert" role="alert"></div>

  <script src="ratings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const gid = id => document.getElementById(id);
    function showDebug(msg){ const a = gid('debugAlert'); if(!a) return; a.textContent=msg; a.style.display='block'; setTimeout(()=>a.style.display='none',3500); }
    function normalizeForHash(raw){ return raw ? encodeURIComponent(String(raw).trim()).toLowerCase() : ''; }

    window.allSeries = [];
    window.seriesSlides = [];
    window.seriesModalInstance = null;
    window.currentSeriesIdx = 0;
    window.currentEntryIdx = 0;

    gid('grid-nav-btn')?.addEventListener('click', ()=> location.href='MovieSeriesGrid.html');

    function showSeriesModal(seriesIdx, entryIdx=0){
      window.currentSeriesIdx = seriesIdx; window.currentEntryIdx = entryIdx;
      const s = window.allSeries[seriesIdx] || {}; const ep = (s.episodes && s.episodes[entryIdx]) || {};
      gid('seriesModalTitle').textContent = ep.title || s.name || '';
      gid('seriesModalPoster').src = ep.poster || '';
      gid('seriesModalSummary').innerHTML = ep.summary || '';
      gid('seriesModalBudget').innerHTML = ep.budget ? `<b>Budget:</b> ${ep.budget}` : '';
      gid('seriesModalEarnings').innerHTML = ep.earnings ? `<b>Earnings:</b> ${ep.earnings}` : '';
      gid('seriesModalScore').innerHTML = (typeof formatRatingBadge === 'function') ? formatRatingBadge(ep.rating,'') : '';
      if(!window.seriesModalInstance) window.seriesModalInstance = new bootstrap.Modal(gid('seriesModal'));
      window.seriesModalInstance.show();
    }

    gid('prevSeriesEntry')?.addEventListener('click', ()=>{
      const s = window.allSeries[window.currentSeriesIdx]; if(!s||!s.episodes) return;
      window.currentEntryIdx = (window.currentEntryIdx - 1 + s.episodes.length) % s.episodes.length;
      showSeriesModal(window.currentSeriesIdx, window.currentEntryIdx);
    });
    gid('nextSeriesEntry')?.addEventListener('click', ()=>{
      const s = window.allSeries[window.currentSeriesIdx]; if(!s||!s.episodes) return;
      window.currentEntryIdx = (window.currentEntryIdx + 1) % s.episodes.length;
      showSeriesModal(window.currentSeriesIdx, window.currentEntryIdx);
    });

    async function loadFromApi(){
      try{
        const res = await fetch('/api/movieseries', { cache: 'no-store' });
        if(!res.ok) throw new Error('api '+res.status);
        const j = await res.json();
        if(!Array.isArray(j)) j=[];
        window.allSeries = j;
        buildUI();
      }catch(err){
        console.error('loadFromApi failed', err);
        showDebug('Failed to load movie series — check server /api/movieseries');
      }
    }

    function buildUI(){
      // carousel
      window.seriesSlides = window.allSeries.map((series, idx)=>{
        const first = (series.episodes && series.episodes[0]) || {};
        return { idx, title:first.title||series.name||'', poster:first.poster||series.poster||'', summary:first.summary||series.summary||'', year:first.year||series.year||'', rating:first.rating };
      });

      const carouselInner = gid('series-carousel-inner');
      carouselInner.innerHTML = '';
      seriesSlides.forEach((s, idx)=>{
        const enc = normalizeForHash(s.title);
        const slide = document.createElement('div');
        slide.className = 'carousel-item'+(idx===0?' active':'');
        slide.setAttribute('data-title', enc);
        slide.innerHTML = `
          <img src="${s.poster||''}" class="d-block w-100 slide-img" loading="lazy" alt="${s.title||''}">
          <div class="carousel-caption d-none d-md-block">
            <h5>${s.title||''}</h5>
            <p>${(s.summary||'').slice(0,160)}${(s.summary && s.summary.length>160)?'...':''}</p>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-sm btn-link p-0" data-view-more-idx="${idx}">View More</button>
              <a class="btn btn-sm btn-outline-light ms-auto" href="MovieSeriesGrid.html#title=${enc}">Open full page</a>
            </div>
          </div>
        `;
        slide.addEventListener('click', (e)=>{ if(e.target.closest('button')||e.target.closest('a')) return; const btn = document.querySelector(`[data-view-more-idx="${idx}"]`); if(btn) btn.click(); });
        carouselInner.appendChild(slide);
      });

      // featured
      const featuredRow = gid('series-featured-row'); featuredRow.innerHTML = '';
      const featured = window.allSeries.slice(-3).reverse();
      featured.forEach(series=>{
        const first = (series.episodes && series.episodes[0]) || {};
        const idx = window.allSeries.indexOf(series);
        const enc = normalizeForHash(first.title || series.name || '');
        const col = document.createElement('div'); col.className='col';
        col.innerHTML = `
          <div class="card shadow-sm h-100" data-title="${enc}">
            <img src="${first.poster||series.poster||''}" class="card-img-top" loading="lazy" style="height:220px;object-fit:cover" alt="${series.name||''}">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${first.title||series.name||''}${first.year? ' ('+first.year+')' : ''}</h5>
              <p class="card-text">${(first.summary||series.summary||'').slice(0,300)}${(first.summary && first.summary.length>300)?'...':''}</p>
              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-sm btn-link p-0" data-view-more-idx="${idx}">View More</button>
                <a class="btn btn-sm btn-outline-primary ms-auto" href="MovieSeriesGrid.html#title=${enc}">Open full page</a>
              </div>
            </div>
          </div>
        `;
        col.querySelector('.card')?.addEventListener('click', (e)=>{ if(e.target.closest('button')||e.target.closest('a')) return; showSeriesModal(idx,0); });
        featuredRow.appendChild(col);
      });

      showDebug('Movie series loaded');
      // if hash present, allow grid to handle but also try to open here by query param
      setTimeout(processQueryTitle, 150);
    }

    function processQueryTitle(){
      try{
        const params = new URLSearchParams(window.location.search);
        const t = params.get('title');
        if(!t) return;
        const target = t.trim().toLowerCase();
        for(let i=0;i<window.allSeries.length;i++){
          const first = (window.allSeries[i].episodes && window.allSeries[i].episodes[0]) || {};
          const candidate = (first.title || window.allSeries[i].name || '').trim().toLowerCase();
          if(candidate === target){ showSeriesModal(i,0); break; }
        }
      }catch(e){ console.warn(e); }
    }

    // delegated quick view
    document.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('[data-view-more-idx]');
      if(!btn) return;
      e.preventDefault();
      const idx = parseInt(btn.getAttribute('data-view-more-idx'),10);
      if(isNaN(idx) || !window.seriesSlides[idx]) return;
      const s = window.seriesSlides[idx];
      gid('seriesQuickViewPoster').src = s.poster || '';
      gid('seriesQuickViewTitle').textContent = s.title || '';
      gid('seriesQuickViewMeta').textContent = [ s.year ? 'Year: '+s.year : '', s.rating ? 'Rating: '+s.rating : '' ].filter(Boolean).join(' · ');
      gid('seriesQuickViewSummary').textContent = s.summary || '';
      const openFull = gid('seriesQuickViewOpenFull');
      if(openFull){
        const href = 'MovieSeriesGrid.html#title=' + normalizeForHash(s.title||'');
        openFull.setAttribute('href', href);
        openFull.onclick = function(ev){ ev.preventDefault(); const qm = bootstrap.Modal.getInstance(gid('seriesQuickViewModal')); if(qm) qm.hide(); location.href = href; };
      }
      new bootstrap.Modal(gid('seriesQuickViewModal')).show();
    });

    loadFromApi();
  </script>
</body>
</html>