<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Series Watched 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .carousel-caption { background: rgba(0,0,0,0.5); border-radius: .5rem; padding: 1rem; color: #fff; }
    .slide-img { width:100%; height:min(60vh,500px); max-height:75vh; object-fit:contain; object-position:center; background-color:#000; display:block; cursor:pointer; }
    .card-img-top { width:100%; aspect-ratio:2/3; object-fit:contain; object-position:center; background-color:#fff; padding:.5rem; display:block; }
    .featured-section { background:#f8f9fa; border-radius:.5rem; padding:2rem 1rem; margin-top:2rem; }
    #seriesModalPoster { max-width:100%; max-height:60vh; object-fit:contain; display:block; margin:0 auto; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button id="back-to-home" class="btn btn-secondary" onclick="window.location.href='index.html'">â¬… Back to Homepage</button>
      <h1 class="mb-0">Movie Series Watched 2025</h1>
      <div></div>
    </div>

    <ul class="nav nav-pills justify-content-center mb-4">
      <li class="nav-item"><a class="nav-link active" href="MovieSeriesReviews.html">Movie Series</a></li>
      <li class="nav-item"><a class="nav-link" href="MovieOneOffs.html">One-Off Movies</a></li>
      <li class="nav-item"><a class="nav-link" href="TelevisionSeriesReviews.html">TV Series</a></li>
    </ul>

    <!-- Carousel -->
    <section class="mb-5">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div id="seriesCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="series-carousel-inner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#seriesCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#seriesCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured -->
    <section class="featured-section">
      <h2 class="mb-4 text-center">Featured</h2>
      <div class="row row-cols-1 row-cols-md-3 g-4" id="series-featured-row"></div>
    </section>
  </div>

  <!-- Series modal -->
  <div class="modal fade" id="seriesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="seriesModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="seriesModalPoster" class="img-fluid mb-3" alt="poster" />
          <p id="seriesModalSummary"></p>
          <p id="seriesModalBudget"></p>
          <p id="seriesModalEarnings"></p>
          <p id="seriesModalScore"></p>
        </div>
        <div class="modal-footer justify-content-between">
          <button id="prevSeriesEntry" class="btn btn-secondary">Previous Entry</button>
          <button id="nextSeriesEntry" class="btn btn-secondary">Next Entry</button>
        </div>
      </div>
    </div>
  </div>

  <script src="ratings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window.allSeries = window.allSeries || [];
    window.currentSeriesIdx = (typeof window.currentSeriesIdx === 'number') ? window.currentSeriesIdx : 0;
    window.currentEntryIdx = (typeof window.currentEntryIdx === 'number') ? window.currentEntryIdx : 0;
    window.seriesModalInstance = window.seriesModalInstance || null;
    var allSeries = window.allSeries;
    var currentSeriesIdx = window.currentSeriesIdx;
    var currentEntryIdx = window.currentEntryIdx;
    var seriesModalInstance = window.seriesModalInstance;

    function showSeriesModal(seriesIdx, entryIdx = 0) {
      currentSeriesIdx = seriesIdx;
      currentEntryIdx = entryIdx;
      window.currentSeriesIdx = currentSeriesIdx;
      window.currentEntryIdx = currentEntryIdx;
      const series = allSeries[currentSeriesIdx] || {};
      const ep = (series.episodes && series.episodes[currentEntryIdx]) || {};
      document.getElementById('seriesModalTitle').textContent = ep.title || series.name || '';
      document.getElementById('seriesModalPoster').src = ep.poster || '';
      document.getElementById('seriesModalSummary').innerHTML = ep.summary || '';
      document.getElementById('seriesModalBudget').innerHTML = ep.budget ? `<b>Budget:</b> ${ep.budget}` : '';
      document.getElementById('seriesModalEarnings').innerHTML = ep.earnings ? `<b>Earnings:</b> ${ep.earnings}` : '';
      document.getElementById('seriesModalScore').innerHTML = (typeof formatRatingBadge === 'function') ? formatRatingBadge(ep.rating, '') : '';
      if (!seriesModalInstance) seriesModalInstance = new bootstrap.Modal(document.getElementById('seriesModal'));
      window.seriesModalInstance = seriesModalInstance;
      seriesModalInstance.show();
    }

    document.getElementById('prevSeriesEntry').addEventListener('click', () => {
      const series = allSeries[currentSeriesIdx];
      if (!series || !series.episodes) return;
      currentEntryIdx = (currentEntryIdx - 1 + series.episodes.length) % series.episodes.length;
      showSeriesModal(currentSeriesIdx, currentEntryIdx);
    });
    document.getElementById('nextSeriesEntry').addEventListener('click', () => {
      const series = allSeries[currentSeriesIdx];
      if (!series || !series.episodes) return;
      currentEntryIdx = (currentEntryIdx + 1) % series.episodes.length;
      showSeriesModal(currentSeriesIdx, currentEntryIdx);
    });

    fetch('/api/movieseries')
      .then(r => r.ok ? r.json() : [])
      .then(list => {
        allSeries = Array.isArray(list) ? list : [];
        window.allSeries = allSeries;

        const carouselInner = document.getElementById('series-carousel-inner');
        carouselInner.innerHTML = '';
        allSeries.forEach((series, idx) => {
          const firstEp = (series.episodes && series.episodes[0]) || {};
          const slide = document.createElement('div');
          slide.className = 'carousel-item' + (idx === 0 ? ' active' : '');
          slide.innerHTML = `
            <img src="${firstEp.poster || ''}" loading="lazy" class="d-block w-100 slide-img" alt="${series.name || ''}">
            <div class="carousel-caption d-none d-md-block" style="cursor:pointer;">
              <h5>${firstEp.title || series.name || ''}${firstEp.year ? ' ('+firstEp.year+')' : ''}</h5>
              <p>${firstEp.summary || ''}</p>
              ${(typeof formatRatingBadge === 'function') ? formatRatingBadge(firstEp.rating, '') : ''}
            </div>
          `;
          slide.addEventListener('click', () => showSeriesModal(idx, 0));
          carouselInner.appendChild(slide);
        });

        const featuredRow = document.getElementById('series-featured-row');
        featuredRow.innerHTML = '';
        const featured = allSeries.slice(-3).reverse();
        let featCounter = 0;
        featured.forEach(series => {
          const firstEp = (series.episodes && series.episodes[0]) || {};
          const col = document.createElement('div');
          col.className = 'col';
          const collapseId = `feat-series-${featCounter++}`;
          const targetTitle = encodeURIComponent((firstEp.title || series.name || '').trim());
          col.innerHTML = `
            <div class="card shadow-sm h-100" style="cursor:pointer">
              <div style="display:flex;gap:1rem;align-items:center;padding:0.75rem;">
                <img src="${firstEp.poster || ''}" loading="lazy" class="card-img-top" style="width:140px;height:140px;flex:0 0 140px;border-radius:.4rem;" alt="${series.name || ''}">
                <div style="flex:1;">
                  <h5 class="card-title mb-1">${firstEp.title || series.name || ''}${firstEp.year ? ' ('+firstEp.year+')' : ''}</h5>
                  <p class="card-text mb-2">${(firstEp.summary || '').slice(0,140)}${(firstEp.summary && firstEp.summary.length>140) ? '...' : ''}</p>
                  <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
                    <a class="btn btn-sm btn-outline-primary ms-auto" href="MovieSeriesReviews.html?title=${targetTitle}">Open full page</a>
                  </div>
                  <div id="${collapseId}" class="collapse mt-2">
                    <p class="mb-2">${firstEp.summary || ''}</p>
                    <a class="btn btn-sm btn-primary" href="MovieSeriesReviews.html?title=${targetTitle}">Open full page</a>
                  </div>
                </div>
              </div>
            </div>
          `;
          col.querySelector('.card').addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) return;
            const idx = allSeries.indexOf(series);
            showSeriesModal(idx, 0);
          });
          featuredRow.appendChild(col);
        });

        // open matching series/entry when ?title= present
       (function openIfTitleInUrl() {
            try {
              const params = new URLSearchParams(window.location.search);
              const titleParam = params.get('title');
              if (!titleParam) return;
              const target = titleParam.trim().toLowerCase();
              let idx = allMovies.findIndex(m => (m.title||'').trim().toLowerCase() === target);
              if (idx === -1) idx = allMovies.findIndex(m => (m.title||'').toLowerCase().includes(target));
              if (idx >= 0) setTimeout(() => showMovieModal(idx), 150);
            } catch (e) { /* ignore */ }
          })();
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>