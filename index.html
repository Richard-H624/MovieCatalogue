<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Reviews â€” Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body>
  <div id="greeting"></div>
<script src="ratings.js"></script>
  <script src="script.js"></script>

  <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Movie Reviews</h1>
      <div class="btn-group">
+        <a class="btn btn-sm btn-outline-primary" href="MovieSeriesReviews.html">Movie Series</a>
+        <a class="btn btn-sm btn-outline-primary" href="MovieOneOffs.html">One-Off Movies</a>
+        <a class="btn btn-sm btn-outline-primary" href="TelevisionSeriesReviews.html">TV Series</a>
      </div>
    </div>

    <!-- Carousel (randomized slides from all sources) -->
    <section class="mb-5">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div id="homeCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="home-carousel-inner"></div>

            <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured: last entry from each page -->
    <section class="featured-section">
      <h2 class="mb-4 text-center">Featured (Most Recent)</h2>
      <div class="row row-cols-1 row-cols-md-3 g-4" id="home-featured-row"></div>
    </section>
  </div>

  <!-- Unified detail modal -->
  <div class="modal fade" id="homeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="homeModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="homeModalPoster" class="img-fluid mb-3" style="max-height:60vh;object-fit:contain;" alt="poster">
          <p id="homeModalSummary"></p>
          <p id="homeModalBudget"></p>
          <p id="homeModalEarnings"></p>
          <p id="homeModalScore"></p>
        </div>
        <div class="modal-footer justify-content-between">
          <div>
            <button id="homePrev" class="btn btn-secondary">Previous</button>
            <button id="homeNext" class="btn btn-secondary">Next</button>
          </div>
          <div>
            <a id="homeGoPage" class="btn btn-primary" href="#">Open page</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm h-100">
  <div style="display:flex;gap:1rem;align-items:center;padding:0.75rem;">
    <img src="${data.poster||''}" class="card-img-top" style="width:140px;height:140px;flex:0 0 140px;border-radius:.4rem;" alt="${title}">
    <div style="flex:1;">
      <h5 class="card-title mb-1">${title}${data.year?` (${data.year})`:''}</h5>
      <p class="card-text mb-2">${(data.summary||'').slice(0,140)}${(data.summary&&data.summary.length>140)?'...':''}</p>

      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
        <a class="btn btn-sm btn-outline-primary ms-auto" href="${page}?title=${encodeURIComponent((data.title||'').trim())}">Open full page</a>
      </div>

      <div id="${collapseId}" class="collapse mt-2">
        <p class="mb-2">${data.summary||''}</p>
        <a class="btn btn-sm btn-primary" href="${page}?title=${encodeURIComponent((data.title||'').trim())}">Open full page</a>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // safe globals
  var slides = window.slides || [];
  var currentSlideIdx = (typeof window.currentSlideIdx === 'number') ? window.currentSlideIdx : 0;
  window.slides = slides;
  window.currentSlideIdx = currentSlideIdx;
  var homeModalInstance = null;

  function shuffleArray(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
  }

  // ...existing code...
function renderCarousel() {
  const inner = document.getElementById('home-carousel-inner');
  inner.innerHTML = '';
  slides.forEach((s, idx) => {
    const active = idx === 0 ? ' active' : '';
    const collapseId = `home-slide-collapse-${idx}`;
    const encodedTitle = encodeURIComponent((s.title||s.name||'').trim());
    const slide = document.createElement('div');
    slide.className = 'carousel-item' + active;
    slide.innerHTML = `
      <img src="${s.poster || ''}" class="d-block w-100 slide-img" alt="${s.title || ''}">
      <div class="carousel-caption d-none d-md-block" style="cursor:default;">
        <h5>${s.title || ''}</h5>
        <p class="mb-1">${(s.summary||'').slice(0,160)}${(s.summary && s.summary.length>160)?'...':''}</p>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-sm btn-link p-0 slide-view-more" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
          <a class="btn btn-sm btn-outline-light ms-auto" href="${s.page || '#'}?title=${encodedTitle}">Open full page</a>
        </div>
        <div id="${collapseId}" class="collapse mt-2 text-start">
          <p class="mb-1">${s.summary || ''}</p>
          <a class="btn btn-sm btn-primary" href="${s.page || '#'}?title=${encodedTitle}">Open full page</a>
        </div>
        <div class="mt-2">${(typeof formatRatingBadge === 'function') ? formatRatingBadge(s.rating,'') : ''}</div>
      </div>
    `;
    // stop "View More" toggle from triggering slide click
    slide.addEventListener('click', (e) => {
      // If the user clicked a collapse toggle or a link, don't open the modal
      if (e.target.closest('.slide-view-more') || e.target.closest('a')) return;
      openHomeModal(idx);
    });
    inner.appendChild(slide);
  });
}
// ...existing code...

  function renderFeatured(lastMovie, lastSeries, lastTv) {
  const row = document.getElementById('home-featured-row');
  row.className = 'stacked-featured';
  row.innerHTML = '';

  const items = [
    { item: lastSeries, title: lastSeries?.title || lastSeries?.name || 'Movie Series', page: 'MovieSeriesReviews.html', typeLabel: 'Movie Series' },
    { item: lastMovie,  title: lastMovie?.title || 'One-Off Movie',             page: 'MovieOneOffs.html',     typeLabel: 'One-Off' },
    { item: lastTv,     title: lastTv?.title || lastTv?.name || 'TV Series',     page: 'TelevisionSeriesReviews.html', typeLabel: 'TV Series' }
  ];

  let _featCounter = 0;

  items.forEach(it => {
    const data = it.item || {};
    const id = `feat-collapse-${_featCounter++}`;
    const pageParamTitle = encodeURIComponent((data.title || data.name || it.title || '').trim());
    const wrapper = document.createElement('div');
    wrapper.className = 'stack-item';
    wrapper.innerHTML = `
      <div class="card shadow-sm h-100">
        <div style="display:flex;gap:1rem;align-items:center;padding:0.75rem;">
          <img src="${data.poster || ''}" class="card-img-top" style="width:140px;height:140px;flex:0 0 140px;border-radius:.4rem;" alt="${it.title}">
          <div style="flex:1;">
            <h5 class="card-title mb-1">${it.title}${data.year ? ' (' + data.year + ')' : ''}</h5>
            <p class="card-text mb-2">${(data.summary || '').slice(0,140)}${(data.summary && data.summary.length>140) ? '...' : ''}</p>

            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#${id}" aria-expanded="false">View More</button>
              <a class="btn btn-sm btn-outline-primary ms-auto" href="${it.page}?title=${pageParamTitle}">Open full page</a>
            </div>

            <div id="${id}" class="collapse mt-2">
              <p class="mb-2">${data.summary || ''}</p>
              <a class="btn btn-sm btn-primary" href="${it.page}?title=${pageParamTitle}">Open full page</a>
            </div>
          </div>
        </div>
      </div>
    `;
    // clicking the whole card goes to page (keep or remove as you prefer)
    wrapper.querySelector('.card').addEventListener('click', (e) => {
      // don't navigate when toggle or link clicked
      if (e.target.closest('button') || e.target.closest('a')) return;
      window.location.href = it.page + (pageParamTitle ? `?title=${pageParamTitle}` : '');
    });
    row.appendChild(wrapper);
  });
}

  function openHomeModal(idx) {
    if (!slides.length) return;
    currentSlideIdx = idx;
    window.currentSlideIdx = currentSlideIdx;
    const s = slides[idx];
    document.getElementById('homeModalTitle').textContent = s.title || s.name || '';
    document.getElementById('homeModalPoster').src = s.poster || '';
    document.getElementById('homeModalSummary').innerHTML = s.summary || '';
    document.getElementById('homeModalBudget').innerHTML = s.budget ? `<b>Budget:</b> ${s.budget}` : '';
    document.getElementById('homeModalEarnings').innerHTML = s.earnings ? `<b>Earnings:</b> ${s.earnings}` : '';
    document.getElementById('homeModalScore').innerHTML = formatRatingBadge(s.rating, '');
    document.getElementById('homeGoPage').href = s.page || '#';
    if (!homeModalInstance) homeModalInstance = new bootstrap.Modal(document.getElementById('homeModal'));
    homeModalInstance.show();
  }

  document.getElementById('homePrev').addEventListener('click', () => {
    if (!slides.length) return;
    currentSlideIdx = (currentSlideIdx - 1 + slides.length) % slides.length;
    openHomeModal(currentSlideIdx);
  });
  document.getElementById('homeNext').addEventListener('click', () => {
    if (!slides.length) return;
    currentSlideIdx = (currentSlideIdx + 1) % slides.length;
    openHomeModal(currentSlideIdx);
  });

  // fetch data from all three APIs, build slides, shuffle, render carousel and featured
  Promise.all([
    fetch('/api/movieseries').then(r => r.ok ? r.json() : []),
    fetch('/api/oneoffs').then(r => r.ok ? r.json() : []),
    fetch('/api/series').then(r => r.ok ? r.json() : [])
  ]).then(([movieSeriesList, oneoffsList, tvList]) => {
    movieSeriesList = Array.isArray(movieSeriesList) ? movieSeriesList : [];
    oneoffsList = Array.isArray(oneoffsList) ? oneoffsList : [];
    tvList = Array.isArray(tvList) ? tvList : [];

    const s = [];
    movieSeriesList.forEach(series => {
      const ep = (series.episodes && series.episodes[0]) || {};
      s.push({
        type: 'movieseries',
        typeLabel: 'Movie Series',
        page: 'MovieSeriesReviews.html',
        seriesName: series.name,
        title: ep.title || series.name,
        poster: ep.poster || '',
        summary: ep.summary || '',
        rating: ep.rating,
        budget: ep.budget,
        earnings: ep.earnings
      });
    });
    oneoffsList.forEach(movie => {
      s.push({
        type: 'oneoff',
        typeLabel: 'One-Off',
        page: 'MovieOneOffs.html',
        title: movie.title || '',
        poster: movie.poster || '',
        summary: movie.summary || '',
        rating: movie.rating,
        budget: movie.budget,
        earnings: movie.earnings,
        year: movie.year
      });
    });
    tvList.forEach(series => {
      const ep = (series.episodes && series.episodes[0]) || {};
      s.push({
        type: 'tv',
        typeLabel: 'TV Series',
        page: 'TelevisionSeriesReviews.html',
        seriesName: series.name,
        title: ep.title || series.name,
        poster: ep.poster || '',
        summary: ep.summary || '',
        rating: ep.rating,
        budget: ep.budget,
        earnings: ep.earnings
      });
    });

    shuffleArray(s);
    slides = s;
    window.slides = slides;

    renderCarousel();

    const lastMovie = oneoffsList.length ? oneoffsList[oneoffsList.length - 1] : null;
    const lastSeries = movieSeriesList.length ? (movieSeriesList[movieSeriesList.length - 1].episodes && movieSeriesList[movieSeriesList.length - 1].episodes[0] ? Object.assign({}, movieSeriesList[movieSeriesList.length - 1].episodes[0], { seriesName: movieSeriesList[movieSeriesList.length - 1].name }) : { name: movieSeriesList[movieSeriesList.length - 1].name }) : null;
    const lastTv = tvList.length ? (tvList[tvList.length - 1].episodes && tvList[tvList.length - 1].episodes[0] ? Object.assign({}, tvList[tvList.length - 1].episodes[0], { seriesName: tvList[tvList.length - 1].name }) : { name: tvList[tvList.length - 1].name }) : null;

    renderFeatured(lastMovie, lastSeries, lastTv);
  }).catch(err => {
    console.error('Failed to load home data', err);
  });
</script>
</body>
</html>