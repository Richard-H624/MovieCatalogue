<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home â€” Movie Reviews</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .carousel-caption { background: rgba(0,0,0,0.5); border-radius:.5rem; padding:1rem; color:#fff; }
    .slide-img { width:100%; height:min(60vh,520px); object-fit:contain; display:block; cursor:pointer; }
    .stacked-feature { display:flex; flex-direction:column; gap:1rem; align-items:center; padding:0 0.5rem; }
    .stack-item { width:100%; max-width:900px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Movie Reviews</h1>
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-primary" href="MovieSeriesReviews.html">Movie Series</a>
        <a class="btn btn-sm btn-outline-primary" href="MovieOneOffs.html">One-Off Movies</a>
        <a class="btn btn-sm btn-outline-primary" href="TelevisionSeriesReviews.html">TV Series</a>
      </div>
    </div>

    <!-- Home carousel -->
    <section class="mb-5">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div id="homeCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="home-carousel-inner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured stacked -->
    <section class="featured-section">
      <h2 class="mb-4 text-center">Featured</h2>
      <div id="home-featured-row" class="stacked-feature"></div>
    </section>
  </div>

  <script src="ratings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script>
    // render carousel slides using JS template literals (no stray ${...} in HTML)
    function renderCarousel(slides) {
      const inner = document.getElementById('home-carousel-inner');
      inner.innerHTML = '';
      slides = Array.isArray(slides) ? slides : [];
      slides.forEach((s, idx) => {
        const collapseId = `home-slide-collapse-${idx}`;
        const encodedTitle = encodeURIComponent((s.title || s.name || '').trim());
        const slide = document.createElement('div');
        slide.className = 'carousel-item' + (idx === 0 ? ' active' : '');
        slide.innerHTML = `
          <img src="${s.poster || ''}" class="d-block w-100 slide-img" alt="${s.title || s.name || ''}">
          <div class="carousel-caption d-none d-md-block" style="cursor:default;">
            <h5>${s.title || s.name || ''}</h5>
            <p class="mb-1">${(s.summary || '').slice(0,160)}${(s.summary && s.summary.length>160)?'...':''}</p>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-sm btn-link p-0 slide-view-more" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
              <a class="btn btn-sm btn-outline-light ms-auto" href="${s.page || '#'}?title=${encodedTitle}">Open full page</a>
            </div>
            <div id="${collapseId}" class="collapse mt-2 text-start">
              <p class="mb-1">${s.summary || ''}</p>
              <a class="btn btn-sm btn-primary" href="${s.page || '#'}?title=${encodedTitle}">Open full page</a>
            </div>
            <div class="mt-2">${(typeof formatRatingBadge === 'function') ? formatRatingBadge(s.rating || s.score, '') : ''}</div>
          </div>
        `;
        // prevent "View More" clicks from triggering slide click (if you have slide click handlers)
        slide.addEventListener('click', (e) => {
          if (e.target.closest('.slide-view-more') || e.target.closest('a')) return;
          if (typeof openHomeModal === 'function') openHomeModal(idx);
        });
        inner.appendChild(slide);
      });
    }

    // render featured stacked cards (last items)
    function renderFeatured(lastSeries, lastMovie, lastTv) {
      const row = document.getElementById('home-featured-row');
      row.innerHTML = '';
      const items = [
        { item: lastSeries, title: lastSeries?.name || lastSeries?.title || 'Movie Series', page: 'MovieSeriesReviews.html' },
        { item: lastMovie,  title: lastMovie?.title || 'One-Off Movie', page: 'MovieOneOffs.html' },
        { item: lastTv,     title: lastTv?.name || lastTv?.title || 'TV Series', page: 'TelevisionSeriesReviews.html' }
      ];

      let counter = 0;
      items.forEach(it => {
        const data = it.item || {};
        const collapseId = `feat-collapse-${counter++}`;
        const encodedTitle = encodeURIComponent((data.title || data.name || it.title || '').trim());
        const wrapper = document.createElement('div');
        wrapper.className = 'stack-item';
        wrapper.innerHTML = `
          <div class="card shadow-sm h-100">
            <div style="display:flex;gap:1rem;align-items:center;padding:0.75rem;">
              <img src="${data.poster || ''}" class="card-img-top" style="width:140px;height:140px;flex:0 0 140px;border-radius:.4rem;" alt="${it.title}">
              <div style="flex:1;">
                <h5 class="card-title mb-1">${it.title}${data.year ? ' ('+data.year+')' : ''}</h5>
                <p class="card-text mb-2">${(data.summary || '').slice(0,140)}${(data.summary && data.summary.length>140)?'...':''}</p>
                <div class="d-flex gap-2 align-items-center">
                  <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
                  <a class="btn btn-sm btn-outline-primary ms-auto" href="${it.page}?title=${encodedTitle}">Open full page</a>
                </div>
                <div id="${collapseId}" class="collapse mt-2">
                  <p class="mb-2">${data.summary || ''}</p>
                  <a class="btn btn-sm btn-primary" href="${it.page}?title=${encodedTitle}">Open full page</a>
                </div>
              </div>
            </div>
          </div>
        `;
        // card click: open page/modal (don't navigate when clicking collapse toggle or link)
        wrapper.querySelector('.card').addEventListener('click', (e) => {
          if (e.target.closest('button') || e.target.closest('a')) return;
          window.location.href = it.page + (encodedTitle ? `?title=${encodedTitle}` : '');
        });
        row.appendChild(wrapper);
      });
    }

    // fetch data and populate the home UI
    Promise.all([
      fetch('/api/oneoffs').then(r => r.ok ? r.json() : []).catch(() => []),
      fetch('/api/movieseries').then(r => r.ok ? r.json() : []).catch(() => []),
      fetch('/api/series').then(r => r.ok ? r.json() : []).catch(() => [])
    ]).then(([oneoffs, movieseries, tvseries]) => {
      // build slides: prioritize one-offs, then movie series first episodes, then tv first episodes
      const slides = [];
      (Array.isArray(oneoffs) ? oneoffs : []).forEach(m => {
        slides.push(Object.assign({}, m, { page: 'MovieOneOffs.html', title: m.title || '' }));
      });
      (Array.isArray(movieseries) ? movieseries : []).forEach(s => {
        const first = (s.episodes && s.episodes[0]) || {};
        slides.push(Object.assign({}, first, { page: 'MovieSeriesReviews.html', title: first.title || s.name || '' }));
      });
      (Array.isArray(tvseries) ? tvseries : []).forEach(s => {
        const first = (s.episodes && s.episodes[0]) || {};
        slides.push(Object.assign({}, first, { page: 'TelevisionSeriesReviews.html', title: first.title || s.name || '' }));
      });

      renderCarousel(slides);

      const lastSeries = (Array.isArray(movieseries) && movieseries.length) ? movieseries[movieseries.length - 1] : null;
      const lastMovie = (Array.isArray(oneoffs) && oneoffs.length) ? oneoffs[oneoffs.length - 1] : null;
      const lastTv = (Array.isArray(tvseries) && tvseries.length) ? tvseries[tvseries.length - 1] : null;
      renderFeatured(lastSeries, lastMovie, lastTv);
    }).catch(err => {
      console.error('Failed to load home data', err);
    });
  </script>
</body>
</html>