<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One-Off Movies Watched 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .carousel-caption { background: rgba(0,0,0,0.5); border-radius: .5rem; padding: 1rem; color: #fff; }
    .slide-img { width:100%; height:min(60vh,500px); max-height:75vh; object-fit:contain; object-position:center; background-color:#000; display:block; cursor:pointer; }
    .card-img-top { width:100%; aspect-ratio:2/3; object-fit:contain; object-position:center; background-color:#fff; padding:.5rem; display:block; }
    #movieModalPoster { max-width:100%; max-height:60vh; object-fit:contain; display:block; margin:0 auto; }
    .featured-section { background:#f8f9fa; border-radius:.5rem; padding:2rem 1rem; margin-top:2rem; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button id="back-to-home" class="btn btn-secondary" onclick="window.location.href='index.html'">â¬… Back to Homepage</button>
      <h1 class="mb-0">One-Off Movies Watched 2025</h1>
      <div></div>
    </div>

    <ul class="nav nav-pills justify-content-center mb-4">
      <li class="nav-item"><a class="nav-link" href="MovieSeriesReviews.html">Movie Series</a></li>
      <li class="nav-item"><a class="nav-link active" aria-current="page" href="MovieOneOffs.html">One-Off Movies</a></li>
      <li class="nav-item"><a class="nav-link" href="TelevisionSeriesReviews.html">TV Series</a></li>
    </ul>

    <!-- Carousel -->
    <section class="mb-5">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div id="oneoffCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="oneoff-carousel-inner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#oneoffCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#oneoffCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured -->
    <section class="featured-section">
      <h2 class="mb-4 text-center">Featured</h2>
      <div class="row row-cols-1 row-cols-md-3 g-4" id="oneoff-featured-row"></div>
    </section>
  </div>

  <!-- Movie modal -->
  <div class="modal fade" id="movieModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="movieModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="movieModalPoster" class="img-fluid mb-3" alt="poster" />
          <p id="movieModalSummary"></p>
          <p id="movieModalBudget"></p>
          <p id="movieModalEarnings"></p>
          <p id="movieModalScore"></p>
        </div>
        <div class="modal-footer justify-content-between">
          <button id="prevMovie" class="btn btn-secondary">Previous Movie</button>
          <button id="nextMovie" class="btn btn-secondary">Next Movie</button>
        </div>
      </div>
    </div>
  </div>

  <script src="ratings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window.allMovies = window.allMovies || [];
    window.currentMovieIdx = (typeof window.currentMovieIdx === 'number') ? window.currentMovieIdx : 0;
    window.movieModalInstance = window.movieModalInstance || null;
    var allMovies = window.allMovies;
    var currentMovieIdx = window.currentMovieIdx;
    var movieModalInstance = window.movieModalInstance;

    function showMovieModal(idx) {
      if (!allMovies || allMovies.length === 0) return;
      currentMovieIdx = ((idx % allMovies.length) + allMovies.length) % allMovies.length;
      window.currentMovieIdx = currentMovieIdx;
      const movie = allMovies[currentMovieIdx] || {};
      document.getElementById('movieModalTitle').textContent = (movie.title || '') + (movie.year ? ` (${movie.year})` : '');
      document.getElementById('movieModalPoster').src = movie.poster || '';
      document.getElementById('movieModalSummary').innerHTML = movie.summary || '';
      document.getElementById('movieModalBudget').innerHTML = movie.budget ? `<b>Budget:</b> ${movie.budget}` : '';
      document.getElementById('movieModalEarnings').innerHTML = movie.earnings ? `<b>Earnings:</b> ${movie.earnings}` : '';
      document.getElementById('movieModalScore').innerHTML = typeof formatRatingBadge === 'function' ? formatRatingBadge(movie.rating) : '';

      if (!movieModalInstance) movieModalInstance = new bootstrap.Modal(document.getElementById('movieModal'));
      window.movieModalInstance = movieModalInstance;
      movieModalInstance.show();
    }

    document.getElementById('prevMovie').addEventListener('click', () => {
      if (!allMovies.length) return;
      currentMovieIdx = (currentMovieIdx - 1 + allMovies.length) % allMovies.length;
      showMovieModal(currentMovieIdx);
    });
    document.getElementById('nextMovie').addEventListener('click', () => {
      if (!allMovies.length) return;
      currentMovieIdx = (currentMovieIdx + 1) % allMovies.length;
      showMovieModal(currentMovieIdx);
    });

    fetch('/api/oneoffs')
      .then(r => r.ok ? r.json() : [])
      .then(list => {
        allMovies = Array.isArray(list) ? list : [];
        window.allMovies = allMovies;

        // carousel slides
        const carouselInner = document.getElementById('oneoff-carousel-inner');
        carouselInner.innerHTML = '';
        allMovies.forEach((movie, idx) => {
          const slide = document.createElement('div');
          slide.className = 'carousel-item' + (idx === 0 ? ' active' : '');
          slide.innerHTML = `
            <img src="${movie.poster || ''}" loading="lazy" class="d-block w-100 slide-img" alt="${movie.title || ''}">
            <div class="carousel-caption d-none d-md-block" style="cursor:pointer;">
              <h5>${movie.title || ''}${movie.year ? ' (' + movie.year + ')' : ''}</h5>
              <p>${movie.summary || ''}</p>
              ${typeof formatRatingBadge === 'function' ? formatRatingBadge(movie.rating, '') : ''}
            </div>
          `;
          slide.addEventListener('click', () => showMovieModal(idx));
          carouselInner.appendChild(slide);
        });

        // featured last 3 with collapsible "View More" + deep link
        const featuredRow = document.getElementById('oneoff-featured-row');
        featuredRow.innerHTML = '';
        const featured = allMovies.slice(-3).reverse();
        let featCounter = 0;
        featured.forEach(movie => {
          const idx = allMovies.indexOf(movie);
          const col = document.createElement('div');
          col.className = 'col';
          const collapseId = `feat-oneoff-${featCounter++}`;
          const targetTitle = encodeURIComponent((movie.title || '').trim());
          col.innerHTML = `
            <div class="card shadow-sm h-100" style="cursor:pointer">
              <div style="display:flex;gap:1rem;align-items:center;padding:0.75rem;">
                <img src="${movie.poster || ''}" loading="lazy" class="card-img-top" style="width:140px;height:140px;flex:0 0 140px;border-radius:.4rem;" alt="${movie.title || ''}">
                <div style="flex:1;">
                  <h5 class="card-title mb-1">${movie.title || ''}${movie.year ? ' (' + movie.year + ')' : ''}</h5>
                  <p class="card-text mb-2">${(movie.summary || '').slice(0,140)}${(movie.summary && movie.summary.length>140) ? '...' : ''}</p>
                  <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">View More</button>
                    <a class="btn btn-sm btn-outline-primary ms-auto" href="MovieOneOffs.html?title=${targetTitle}">Open full page</a>
                  </div>
                  <div id="${collapseId}" class="collapse mt-2">
                    <p class="mb-2">${movie.summary || ''}</p>
                    <a class="btn btn-sm btn-primary" href="MovieOneOffs.html?title=${targetTitle}">Open full page</a>
                  </div>
                </div>
              </div>
            </div>
          `;
          col.querySelector('.card').addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) return;
            showMovieModal(idx);
          });
          featuredRow.appendChild(col);
        });

        // if ?title=... in URL open matching movie
       (function openIfTitleInUrl() {
           try {
              const params = new URLSearchParams(window.location.search);
              const titleParam = params.get('title');
              if (!titleParam) return;
              const target = titleParam.trim().toLowerCase();
              let idx = allMovies.findIndex(m => (m.title||'').trim().toLowerCase() === target);
              if (idx === -1) idx = allMovies.findIndex(m => (m.title||'').toLowerCase().includes(target));
              if (idx >= 0) setTimeout(() => showMovieModal(idx), 150);
            } catch (e) { /* ignore */ }
          })();
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>